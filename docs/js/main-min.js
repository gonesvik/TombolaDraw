"use strict";const max_ticket_num=99999,tooManyTickets=99999;var timer,version="4.2.1",author="By Geir Ove Nesvik",splashScreenImg='<img id="splash-screen" src="images/tombola-splash-001.webp" alt="Splash screen" class="w3-card-4"></img>',ticketFontSize="48vmin",drawHistory=[],tickets={},historyIndex=-1,overlaps=[new Set([NaN])],color_classes=["color-pale-blue","color-pale-green","color-pale-red","color-pale-yellow","color-bright-blue","color-bright-green","color-bright-red","color-bright-yellow","color-brown","color-orange","color-purple","color-teal","color-aluminium","color-gold","color-paper","color-wood"],slider=document.getElementById("select-seconds"),disclosureTime=slider.value,color_index=0;function setColorClass(e,t){var l;for(l of color_classes)e.classList.remove(l);e.style.backgroundColor="",e.style.color="","unspecified"==(l=t)&&(l=color_classes[color_index],color_index=color_index>=15?0:color_index+1,e.querySelector(".select-color ."+l).selected="selected"),e.classList.add(l)}function addItem(){var e=document.querySelector("tbody"),t=e.querySelectorAll("tr")[0].cloneNode(!0);setColorClass(t,"unspecified"),t.querySelector(".item-no").textContent=e.querySelectorAll("tr").length+1,t.querySelector(".first-number").value="1",t.querySelector(".last-number").value=null,t.querySelector(".status-light").style.backgroundColor="orange",t.querySelector(".num-tickets").textContent="0",e.appendChild(t),t.scrollIntoView(),overlaps.push(new Set([NaN]))}function checkOverlaps(e){var t,l,o,r,n=document.querySelectorAll(".formItem"),s=e.srcElement.closest("tr"),c=s.rowIndex-1,d=Number(s.querySelector(".first-number").value),a=Number(s.querySelector(".last-number").value);!Number.isInteger(d)||!Number.isInteger(a)||d<=0||d>a?(overlaps[c].forEach((e=>{e>=0&&overlaps[e].delete(c)})),overlaps[c].clear,overlaps[c].add(NaN)):n.forEach(((e,s)=>{if(d=Number(e.querySelector(".first-number").value),a=Number(e.querySelector(".last-number").value),!(d<=0||a<d)){overlaps[s].delete(NaN),t=e.querySelector(".select-color").value,l=e.querySelector(".select-letter").value;for(var c=s+1;c<n.length&&c<overlaps.length;c++)o=Number(n[c].querySelector(".first-number").value),r=Number(n[c].querySelector(".last-number").value),n[c].querySelector(".select-color").value!==t||n[c].querySelector(".select-letter").value!==l||o>a||r<d||o<=0||r<o?(overlaps[c].delete(s),overlaps[s].delete(c)):(overlaps[c].add(s),overlaps[s].add(c))}})),setStatusLights()}function countTickets(e){var t=e.srcElement.closest(".formItem"),l=Number(t.querySelector(".first-number").value),o=Number(t.querySelector(".last-number").value),r=o-l+1,n=0;t.querySelector(".num-tickets").textContent=l>0&&r>=0?r:"0",document.querySelectorAll(".num-tickets").forEach((e=>{n+=Number(e.textContent)})),o>99999?raiseAlert(102):n>99999&&raiseAlert(103),document.querySelector("#totalNo").textContent=n||"0"}function drawTicket(){var e,t=Object.keys(tickets).length,l=document.getElementById("winner-ticket"),o=document.getElementById("ticket-text"),r=document.getElementById("menu-icon"),n=document.getElementById("spinner-panel");t>0&&(r.style.color="black",l.style.display="none",n.style.display=disclosureTime>0?"flex":"none",e=Object.keys(tickets)[Math.floor(Math.random()*t)],drawHistory.push(tickets[e]),document.getElementById("logItem").textContent=drawHistory.length,setColorClass(l,tickets[e][0]),r.style.color=getComputedStyle(l).color,o.textContent=tickets[e][1],1===drawHistory.length&&(o.style.fontSize=ticketFontSize,document.getElementById("regret").style.display="none",document.getElementById("reset-warning").textContent="This will end the current round and reset the app."),delete tickets[e],historyIndex=drawHistory.length-1,document.getElementById("prev").disabled=!historyIndex,document.getElementById("draw").style.opacity=t>1?1:.3,document.getElementById("next").disabled=!0,document.getElementById("repetition").style.display="none",setTimeout((()=>{l.style.display="flex",n.style.display="none"}),1e3*disclosureTime))}function startReview(){0!=document.getElementsByTagName("input")[0].readOnly&&(clearTimeout(timer),document.getElementById("spinner-panel").style.display="none",document.getElementById("winner-ticket").style.display="none",document.getElementsByTagName("html")[0].style.backgroundColor="beige",document.getElementById("menu-icon").style.color="black",document.getElementById("registration").style.display="block",document.querySelectorAll(".buttonSet").forEach((e=>{e.style.display="none"})),document.querySelector("#close").style.display="inline-block")}function endReview(){document.getElementById("registration").scrollTop=0,document.getElementById("registration").style.display="none",document.getElementById("winner-ticket").style.display="flex",document.getElementsByTagName("html")[0].style.backgroundColor="whitesmoke",document.getElementById("menu-icon").style.color=getComputedStyle(document.getElementById("ticket-text")).color,document.querySelectorAll(".buttonSet").forEach((e=>{e.style.display="inline-block"})),document.querySelector("#close").style.display="none",drawHistory.length>0&&drawHistory.length>historyIndex&&(document.getElementById("repetition").style.display="flex",document.getElementById("regret").style.display="none"),document.getElementById("draw").disabled=!1,document.getElementById("prev").disabled=!(historyIndex>0),document.getElementById("next").disabled=!(drawHistory.length>historyIndex+1)}function confirmMixingTime(){disclosureTime=slider.value,document.getElementById("mixTimeCard").style.display="none"}function resetMixingTime(){document.querySelector("#select-seconds").value=disclosureTime,document.getElementById("mixTime").textContent=parseFloat(disclosureTime).toFixed(1),document.getElementById("mixTimeCard").style.display="none"}function raiseAlert(e){var t;switch(e){case 101:t="Total number of tickets is too small. Minimum is 2.";break;case 102:t="Ticket number is too big. Maximum is 99999.";break;case 103:t="Total number of tickets is too big. Maximum is 99999.";break;case 104:t="Two or more ticket ranges are overlapping.";break;default:t="Unexpected condition."}document.querySelector("#alert-text").textContent=t,document.querySelector("#alert").style.display="block"}function registerTickets(e){var t,l,o,r,n,s,c,d=document.querySelector("table"),a=1,i=e;i<2&&raiseAlert(101),i>99999&&raiseAlert(103);for(var m=0;m<overlaps.length&&!(overlaps[m].size>0&&!1===overlaps[m].has(NaN));m++);m<overlaps.length&&raiseAlert(104),i=0;for(m=0;m<d.rows.length-2;m++){for(l=d.querySelectorAll(".formItem .select-color")[m].value,t=d.querySelectorAll(".formItem .select-letter")[m].value,o=Number(d.querySelectorAll(".formItem .first-number")[m].value),r=Number(d.querySelectorAll(".formItem .last-number")[m].value),s=o;0<s&&s<=r;s++)n=t>="A"?t+" "+s.toString():s.toString(),tickets[i++]=[l,n];a=Math.max(n.length,a)}ticketFontSize=String(24+4*(7-a))+"vmin",document.querySelectorAll("input").forEach((e=>{e.readOnly=!0})),document.querySelectorAll(".select-color, .select-letter").forEach((e=>{e.disabled=!0})),document.querySelectorAll(".cancel-x").forEach((e=>{e.classList.remove("remove-item")})),window.scrollTo(0,0),document.getElementById("page-heading").textContent="REGISTERED TICKETS",document.getElementById("read-only").style.display="grid",document.getElementById("review-button").style.opacity="1.0",(c=document.getElementById("registration")).scrollTop=0,c.style.display="none",(c=document.getElementById("winner-ticket")).style.display="flex",document.getElementById("draw").disabled=!1,document.getElementById("prev").disabled=!0,document.getElementById("next").disabled=!0,window.addEventListener("keyup",keyPressed,!0)}function regretRegistration(){var e;document.querySelector("table");document.querySelectorAll("input").forEach((e=>{e.readOnly=!1})),document.querySelectorAll(".select-color, .select-letter").forEach((e=>{e.disabled=!1})),document.querySelectorAll(".cancel-x").forEach((e=>{e.classList.add("remove-item")})),window.scrollTo(0,0),document.getElementById("page-heading").textContent="REGISTER TICKETS",document.getElementById("read-only").style.display="none",document.getElementById("review-button").style.opacity="0.3",(e=document.getElementById("registration")).scrollTop=0,e.style.display="block",e=document.getElementById("winner-ticket").style.display="none",document.getElementById("draw").disabled=!0}function removeItem(e){var t=Number(document.querySelector("#totalNo").textContent),l=document.querySelectorAll(".formItem");if(l.length>1){const r=e.closest("tr").rowIndex-1;t-=Number(l[r].querySelector(".num-tickets").textContent);for(var o=0;o<l.length;o++)if(o!==r){o>r&&(l[o].querySelector(".item-no").textContent=o),overlaps[o].delete(r);for(let e of new Set(overlaps[o]))e<=r||(overlaps[o].delete(e),overlaps[o].add(e-1))}e.closest("tr").remove(),overlaps.splice(r,1)}else setColorClass(l[0],"unspecified"),l[0].querySelector(".select-letter").value="",l[0].querySelector(".first-number").value=1,l[0].querySelector(".last-number").value="",l[0].querySelector(".num-tickets").textContent="0",overlaps=[new Set([NaN])],t=0;document.querySelector("#totalNo").textContent=t||"0",setStatusLights()}function resetApp(){var e,t;for(color_index=0,clearTimeout(timer),document.getElementsByTagName("html")[0].style.backgroundColor="whitesmoke",document.getElementById("spinner-panel").style.display="none",document.getElementById("confirm").style.display="none",document.getElementById("registration").style.display="block",document.getElementById("winner-ticket").style.display="none",document.getElementById("page-heading").textContent="TICKET REGISTRATION",document.getElementById("read-only").style.display="none",document.getElementById("reset-warning").textContent="This will reset the app.",t=(e=document.getElementsByClassName("formItem")).length-1;t>0;t--)e[t].remove();for(t in setColorClass(e[0],"unspecified"),e[0].querySelector(".select-letter").value="",e[0].querySelector(".first-number").value=1,e[0].querySelector(".last-number").value="",e[0].querySelector(".num-tickets").textContent="0",e=document.getElementsByTagName("input"),[0,1])e[t].readOnly=!1;document.getElementById("menu-icon").style.color="black",document.getElementById("add").disabled=!1,document.getElementById("repetition").style.display="none",document.getElementById("winner-ticket").removeAttribute("class"),document.getElementById("ticket-text").innerHTML=splashScreenImg,document.getElementById("logItem").textContent=" ",document.getElementById("totalNo").textContent="0",document.getElementById("prev").disabled=!0,document.getElementById("next").disabled=!0,document.getElementById("review-button").style.opacity="0.3",document.getElementById("draw").style.opacity=1,document.getElementById("regret").style.display="none",document.getElementsByClassName("status-light")[0].style.backgroundColor="Orange",document.getElementsByClassName("num-tickets")[0].textContent="0",document.querySelectorAll(".select-color, .select-letter").forEach((e=>{e.disabled=!1})),document.querySelectorAll(".cancel-x").forEach((e=>{e.classList.add("remove-item")})),document.querySelectorAll(".buttonSet").forEach((e=>{e.style.display="inline-block"})),document.querySelector("#close").style.display="none",overlaps=[new Set([NaN])],drawHistory=[],tickets={},historyIndex=-1}function setStatusLights(){var e;overlaps.forEach(((t,l)=>{e="green",t.size>0&&(e="red"),t.has(NaN)&&(e="orange"),document.querySelectorAll(".formItem .status-light")[l].style.backgroundColor=e}))}function traverseHistory(e){historyIndex+=e,document.getElementById("prev").disabled=0===historyIndex,document.getElementById("next").disabled=historyIndex===drawHistory.length-1,setColorClass(document.getElementById("winner-ticket"),drawHistory[historyIndex][0]),document.getElementById("repetition").style.display="flex",document.getElementById("ticket-text").textContent=drawHistory[historyIndex][1].toString();var t=document.getElementById("ticket-text"),l=t.cloneNode(!0);t.parentNode.replaceChild(l,t),document.getElementById("logItem").textContent=historyIndex+1,document.getElementById("menu-icon").style.color=getComputedStyle(document.getElementById("ticket-text")).color}function keyPressed(e){var t=e.keyCode;if("flex"==document.querySelector("#winner-ticket").style.display)switch(t){case 13:case 32:drawTicket();break;case 37:case 80:historyIndex>0&&traverseHistory(-1);break;case 39:case 78:historyIndex<drawHistory.length-1&&traverseHistory(1);break}}document.getElementById("mixTime").textContent=parseFloat(slider.value).toFixed(1),slider.oninput=function(){slider.textContent=this.value,document.getElementById("mixTime").textContent=parseFloat(slider.value).toFixed(1)},setColorClass(document.getElementsByClassName("formItem")[0],"unspecified"),document.getElementById("version").textContent=version,document.getElementById("author").textContent=author,document.getElementById("ticket-text").innerHTML=splashScreenImg,document.addEventListener("input",(function(e){e.target&&("first-number"!=e.target.className&&"last-number"!=e.target.className||(countTickets(e),checkOverlaps(e)))})),document.addEventListener("click",(function(e){if(!1!==e.target)if(e.target.classList.contains("remove-item"))removeItem(e.target);else switch(e.target.id){case"add":addItem();break;case"ready":registerTickets(Number(this.getElementById("totalNo").textContent));break;case"regret":regretRegistration();break;case"close":endReview();break;case"draw":drawTicket();break;case"next":traverseHistory(1);break;case"prev":traverseHistory(-1);break}})),document.getElementById("registration").addEventListener("change",(function(e){if(e.target)if("select-color"==e.target.className){var t,l=e.target.value,o=e.target.closest("tr");for(t of color_classes)o.classList.remove(t);o.classList.add(l),checkOverlaps(e)}else"select-letter"==e.target.className&&checkOverlaps(e)}));